<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="robots" content="noindex">
    <title>SHRI - homework #1</title>
    <link rel="stylesheet" href="dist/main.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="content">
        <header class="header">
            <div class="header__inner">
                <a href="/" class="logo"></a>
                <div class="container">
                <ul class="list-inline list-unstyled header__menu">
                    <li class="header__menu-item"><a href="#" class="header__menu-link">События</a></li>
                    <li class="header__menu-item"><a href="#" class="header__menu-link">Сводка</a></li>
                    <li class="header__menu-item"><a href="#" class="header__menu-link">Устройства</a></li>
                    <li class="header__menu-item"><a href="#" class="header__menu-link">Сценарии</a></li>
                    <li class="header__menu-item active"><a href="video.html" class="header__menu-link">Видео</a></li>
                </ul>
                <div id="js-side-menu-trigger" class="hamburger">
                    <div class="hamburger__icon"></div>
                </div>
                </div>
            </div>
        </header>
        <main>
            <div class="container">
                <div class="videotiles">
                    <div class="videotile">
                        <div class="card-video">
                            <video id="video-1" class="video" muted autoplay></video>
                            <div class="card-video__controls">
                                <div class="card-video__controls-top">
                                    <div class="card-video__control">
                                        <div class="card-video__brightness">Яркость:</div>
                                        <input type="range" class="card-video__input card-video__input-brightness" value="100" min="0" max="200">
                                    </div>
                                    <div class="card-video__control">
                                        <div class="card-video__contrast">Контрастность:</div>
                                        <input type="range" class="card-video__input card-video__input-contrast" value="100" min="0" max="200">
                                    </div>
                                </div>
                                <div class="card-video__controls-bottom">
                                    <div class="card-video__control">
                                    <a href="#" class="btn btn_size_xs btn_type_transparent card-video__btn">Все камеры</a>
                                    </div>
                                    <div class="card-video__control">
                                        <canvas class="card-video__volume"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="videotile">
                        <div class="card-video">
                            <video id="video-2" class="video" muted autoplay></video>
                            <div class="card-video__controls">
                                <div class="card-video__controls-top">
                                    <div class="card-video__control">
                                        <div class="card-video__brightness">Яркость:</div>
                                        <input type="range" class="card-video__input card-video__input-brightness" value="100" min="0" max="200">
                                    </div>
                                    <div class="card-video__control">
                                        <div class="card-video__contrast">Контрастность:</div>
                                        <input type="range" class="card-video__input card-video__input-contrast" value="100" min="0" max="200">
                                    </div>
                                </div>
                                <div class="card-video__controls-bottom">
                                    <div class="card-video__control">
                                        <a href="#" class="btn btn_size_xs btn_type_transparent card-video__btn">Все камеры</a>
                                    </div>
                                    <div class="card-video__control">
                                        <canvas class="card-video__volume"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="videotile">
                        <div class="card-video">
                            <video id="video-3" class="video" muted autoplay></video>
                            <div class="card-video__controls">
                                <div class="card-video__controls-top">
                                    <div class="card-video__control">
                                        <div class="card-video__brightness">Яркость:</div>
                                        <input type="range" class="card-video__input card-video__input-brightness" value="100" min="0" max="200">
                                    </div>
                                    <div class="card-video__control">
                                        <div class="card-video__contrast">Контрастность:</div>
                                        <input type="range" class="card-video__input card-video__input-contrast" value="100" min="0" max="200">
                                    </div>
                                </div>
                                <div class="card-video__controls-bottom">
                                    <div class="card-video__control">
                                        <a href="#" class="btn btn_size_xs btn_type_transparent card-video__btn">Все камеры</a>
                                    </div>
                                    <div class="card-video__control">
                                        <canvas class="card-video__volume"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="videotile">
                        <div class="card-video">
                            <video id="video-4" class="video" muted autoplay></video>
                            <div class="card-video__controls">
                                <div class="card-video__controls-top">
                                    <div class="card-video__control">
                                        <div class="card-video__brightness">Яркость:</div>
                                        <input type="range" class="card-video__input card-video__input-brightness" value="100" min="0" max="200">
                                    </div>
                                    <div class="card-video__control">
                                        <div class="card-video__contrast">Контрастность:</div>
                                        <input type="range" class="card-video__input card-video__input-contrast" value="100" min="0" max="200">
                                    </div>
                                </div>
                                <div class="card-video__controls-bottom">
                                    <div class="card-video__control">
                                        <a href="#" class="btn btn_size_xs btn_type_transparent card-video__btn">Все камеры</a>
                                    </div>
                                    <div class="card-video__control">
                                        <canvas class="card-video__volume"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="footer">
            <div class="footer__inner">
                <ul class="list-inline list-unstyled footer__links">
                    <li class="footer__links-item"><a href="#" class="footer__link">Помощь</a></li>
                    <li class="footer__links-item"><a href="#" class="footer__link">Обратная связь</a></li>
                    <li class="footer__links-item"><a href="#" class="footer__link">Разработчикам</a></li>
                    <li class="footer__links-item"><a href="#" class="footer__link">Условия использования</a></li>
                    <li class="footer__links-item"><a href="https://docviewer.yandex.ru/view/1130000031416129/?*=NDquAwEqAaHVit0R666Z9nfyxRB7InVybCI6InlhLXdpa2k6Ly93aWtpLWFwaS55YW5kZXgucnUvc2hyaS0yMDE4LWlpL2hvbWV3b3JrL2FkYXB0aXZuYWphLXZqb3JzdGthL2xpY2Vuc2UucGRmIiwidGl0bGUiOiJsaWNlbnNlLnBkZiIsInVpZCI6IjExMzAwMDAwMzE0MTYxMjkiLCJ5dSI6IjYzNTM1OTM5NDE0OTU4MzYxMTciLCJub2lmcmFtZSI6ZmFsc2UsInRzIjoxNTM4ODkzMjg3MTY0fQ%3D%3D" class="footer__link">Авторские права</a></li>
                </ul>
                <div class="footer__copyright">© 2001–2017 &nbsp;ООО «Яндекс»</div>
            </div>
        </footer>
    </div>
    <div class="side-menu">
        <div class="side-menu__content">
            <div class="side-menu__header">
                <div class="logo"></div>
                <div class="cross side-menu__cross">×</div>
            </div>
            <ul class="list-unstyled side-menu__list">
                <li class="side-menu__item"><a href="#" class="menu__link">События</a></li>
                <li class="side-menu__item"><a href="#" class="menu__link">Сводка</a></li>
                <li class="side-menu__item"><a href="#" class="menu__link">Устройства</a></li>
                <li class="side-menu__item"><a href="#" class="menu__link">Сценарии</a></li>
                <li class="side-menu__item active"><a href="video.html" class="menu__link">Видео</a></li>
            </ul>
        </div>
    </div>
    <script>

//        class Stream {
//            constructor(video, url) {
//                if (Hls.isSupported()) {
//                    const hls = new Hls();
//                    hls.loadSource(url);
//                    hls.attachMedia(video);
//
//                    hls.on(Hls.Events.MANIFEST_PARSED, function (e, data) {
//                        // Ставим начальное качество минимальным
//                        console.log(hls);
//                        hls.autoLevelEnabled = false;
//                        hls.loadLevel = 0;
//                        video.play();
//                    });
//
////                    return hls;
//                }
//                else if (video.canPlayType('application/vnd.apple.mpegurl')) {
//                    video.src = url;
//                    video.addEventListener('loadedmetadata', function () {
//                        video.play();
//                    });
//                }
//            }
//        }

function initHls(video, url) {
    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function (e, data) {
            // Ставим начальное качество минимальным
             hls.autoLevelEnabled = false;
             hls.loadLevel = 0;
            video.play();
//            console.log(hls);
        });

        return hls;
    }
    else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', function () {
            video.play();
        });
    }
}

//let hlsVideo1 = initVideo(
//    document.getElementById('video-1'),
//    'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fsosed%2Fmaster.m3u8'
//);
//
//
//let hlsVideo2 = initVideo(
//    document.getElementById('video-2'),
//    'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fcat%2Fmaster.m3u8'
//);
//
//let hlsVideo3 = initVideo(
//    document.getElementById('video-3'),
//    'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fdog%2Fmaster.m3u8'
//);
//
//let hlsVideo4 = initVideo(
//    document.getElementById('video-4'),
//    'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fhall%2Fmaster.m3u8'
//);


function initVideocontrol() {

    let activeVideo = {
        el: null,
        volume: null
    };

    const streams = [
        'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fsosed%2Fmaster.m3u8',
        'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fcat%2Fmaster.m3u8',
        'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fdog%2Fmaster.m3u8',
        'http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fhall%2Fmaster.m3u8'
    ];

    const hlsArray = [];

    /* Массив источников*/
    let audioSources = {};
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    // Аудио-контекст
    const context = new AudioContext();
    const node = context.createScriptProcessor(2048, 1, 1);
    node.connect(context.destination);
    // Анализатор
    const analyser = context.createAnalyser();
    analyser.smoothingTimeConstant = 0.3;
    analyser.fftSize = 512;
    analyser.connect(node);
    let activeVolume = null;

    // Все видео
    const videos = document.querySelectorAll('.video');
    // Кнопка "Все камеры"
    const cardsBtn = document.querySelectorAll('.card-video__btn');

    /**
     * Подключает определенную камеру
     **/
    function connectAudioSource(video) {
        let id = video.id;

        if (!audioSources[id]) {
            audioSources[id] = context.createMediaElementSource(video);
        }

        audioSources[id].connect(analyser);
        audioSources[id].connect(context.destination);

    }

    /**
     * Событие поступление данных
     **/
    node.onaudioprocess = () => {

        if (activeVolume) {
            const volumeArray = new Uint8Array(analyser.frequencyBinCount);
            // Получаем данные от анализатора
            analyser.getByteFrequencyData(volumeArray);
            const volumeAverage = getAverageVolume(volumeArray);
            console.log(activeVolume.canvas.width);

            activeVolume.clearRect(0, 0, activeVolume.canvas.width, activeVolume.canvas.height);
            activeVolume.fillStyle = '#ffdb4d';
            activeVolume.fillRect(0, 0, 2 * volumeAverage, activeVolume.canvas.height);
        }
    };

    /**
     * Считает среднее массива частот с источника
     **/
    function getAverageVolume(array) {
        let length = array.length;
        let sum = 0;

        for (let i = 0; i < array.length; i++) {
            sum += array[i];
        }

        return sum / length;
    }


    // Событие - открытие окна
    for (let i = 0; i < videos.length; i++) {
        hlsArray[i] = initHls(videos[i], streams[i]);
//        console.log(hlsArray[i]);

        videos[i].addEventListener('click', () => {
            openFullScreen(videos[i]);
        });
    }

    // Событие - закрытие окна
    for (let i = 0; i < cardsBtn.length; i++) {
        cardsBtn[i].addEventListener('click', (e) => {
            closeFullScreen(cardsBtn[i], e);
        });
    }

    /**
     * Открытие фулл режима
     **/
    function openFullScreen(video) {
        const container = video.parentNode;
        activeVolume = container.querySelector('.card-video__volume').getContext("2d");

        if (container.classList.contains('active'))
            return;

        // Инф-ия о блоке видео
        const videoData = video.getBoundingClientRect();
        const videoWrap = video.parentNode;
//        video.style.width = videoData.width + 'px';
//        video.style.height = videoData.height + 'px';
        container.classList.add('active');
        video.muted = false;

        connectAudioSource(video);

        // Позиции центра экрана
        let positionCenterX = (document.body.clientWidth / 2) - videoData.x - (videoData.width / 2);
        let positionCenterY = (document.body.clientHeight / 2) - videoData.y - (videoData.height / 2);
        videoWrap.style.transform = `translate3d(${positionCenterX}px, ${positionCenterY}px, 0) scale(2)`;

    // hlsVideo1.loadLevel = 2;
        // }
    }

    /**
     * Закрытие full режима
     * @type {NodeList}
     */
    function closeFullScreen(button, e) {
        e.preventDefault();
        const parent = button.closest('.card-video');
        const video = parent.querySelector('video');
        parent.style.transform = null;
        video.muted = true;
        audioSources[video.id].disconnect();
//        video.disconnect();

        setTimeout(() => {
            parent.classList.remove('active');
        }, 200);

        e.stopPropagation();
    }

    /**
     * Изменение яркости
     * @type {NodeList}
     */
    let cardsInputBrightness = document.querySelectorAll('.card-video__input-brightness');

    for (let i = 0; i < cardsInputBrightness.length; i++) {
        cardsInputBrightness[i].addEventListener('input', function (e) {
            this.closest('.card-video').querySelector('.video').style.filter = `brightness(${this.value}%)`;
        });
    }

    /**
     * Изменение Контрастности
     * @type {NodeList}
     */
    let cardsInputContrast = document.querySelectorAll('.card-video__input-contrast');

    for (let i = 0; i < cardsInputContrast.length; i++) {
        cardsInputContrast[i].addEventListener('input', function (e) {
            this.closest('.card-video').querySelector('.video').style.filter = `contrast(${this.value}%)`;
        });
    }



    function drawSpectrogram(array) {

        // copy the current canvas onto the temp canvas
        var canvas = document.getElementById("canvas");

        tempCtx.drawImage(canvas, 0, 0, 800, 512);

        // iterate over the elements from the array
        for (var i = 0; i < array.length; i++) {
            // draw each pixel with the specific color
            var value = array[i];
            ctx.fillStyle = hot.getColor(value).hex();

            // draw the line at the right side of the canvas
            ctx.fillRect(800 - 1, 512 - i, 1, 1);
        }

        // set translate on the canvas
        ctx.translate(-1, 0);
        // draw the copied image
        ctx.drawImage(tempCanvas, 0, 0, 800, 512, 0, 0, 800, 512);

        // reset the transformation matrix
        ctx.setTransform(1, 0, 0, 1, 0, 0);
    }

}


document.addEventListener('DOMContentLoaded', () => {
    initVideocontrol();
})



    </script>
</body>
</html>





